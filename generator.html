<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gudangku Generator (UI Fix)</title>
    
    <link rel="stylesheet" href="neobrutalism.css">

    <script src="libs/pizzip.js"></script>
    <script src="libs/docxtemplater.js"></script>
    <script src="libs/FileSaver.js"></script>
    <script>
        if (typeof PizZip === 'undefined') document.write('<script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"><\/script>');
        if (typeof window.docxtemplater === 'undefined') document.write('<script src="https://unpkg.com/docxtemplater@3.37.11/build/docxtemplater.js"><\/script>');
        if (typeof saveAs === 'undefined') document.write('<script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"><\/script>');
    </script>

    <style>
        body { padding-bottom: 50px; }
        .upload-zone { border: 4px dashed var(--nb-black); background: #f0f0f0; padding: 40px; text-align: center; cursor: pointer; font-weight: 900; font-family: var(--font-main); }
        .auto-field { background-color: #e8f0fe; color: #333; font-weight: bold; pointer-events: none; }
        
        /* Style Checkbox Baru */
        .toggle-btn {
            display: flex; align-items: center; justify-content: center; gap: 5px;
            background: #fff; border: 2px solid black; padding: 5px; 
            box-shadow: 2px 2px 0px black; cursor: pointer; font-weight: bold; font-size: 0.8em;
        }
        .toggle-btn:hover { background: #ffde00; transform: translate(-1px, -1px); }
        .toggle-btn input { cursor: pointer; margin: 0; }
        
        .row-disabled input[type="text"], .row-disabled input[type="number"] { 
            background: #eee; color: #aaa; text-decoration: line-through; 
        }
        .text-center { text-align: center; vertical-align: middle; }
    </style>
</head>
<body>

    <nav class="navbar mb-5">
        <div class="navbar-brand">GUDANGKU <span style="background:var(--nb-black); color:var(--nb-white); padding:0 5px;">GEN</span></div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header bg-secondary">Langkah 1: Siapkan Template</div>
            <div class="card-body">
                <div class="upload-zone w-100" onclick="document.getElementById('templateInput').click()">
                    <span style="font-size: 2rem;">ðŸ“‚</span><br>KLIK UPLOAD TEMPLATE
                    <input type="file" id="templateInput" accept=".docx" onchange="handleFileSelect(this)" style="display:none;">
                    <div id="filename-display" style="margin-top:10px; color:blue;"></div>
                </div>
            </div>
        </div>

        <div id="app-content" style="opacity: 0.5; pointer-events: none;">
            <div class="card">
                <div class="card-header bg-primary text-white">Langkah 2: Isi Data</div>
                <div class="card-body">
                    
                    <h4 class="mb-2" style="border-bottom: 3px solid black;">1. Data Surat</h4>
                    <div class="row">
                        <div class="col-4"><div class="form-group"><label class="form-label">No Quote</label><input type="text" class="form-control" id="no_quote" value="Q-001/XII/2025"></div></div>
                        <div class="col-4"><div class="form-group"><label class="form-label">Tanggal</label><input type="date" class="form-control" id="date" onchange="updateValidity()"></div></div>
                        <div class="col-4"><div class="form-group"><label class="form-label">Validity</label><input type="text" class="form-control auto-field" id="validity" readonly></div></div>
                    </div>

                    <h4 class="mb-2 mt-2" style="border-bottom: 3px solid black;">2. Data Klien</h4>
                    <div class="row">
                        <div class="col-6"><div class="form-group"><label class="form-label">Perusahaan</label><input type="text" class="form-control" id="perusahaan" placeholder="PT..."></div></div>
                        <div class="col-6"><div class="form-group"><label class="form-label">Nama PIC</label><input type="text" class="form-control" id="pic"></div></div>
                        <div class="col-6"><div class="form-group"><label class="form-label">NPWP</label><input type="text" class="form-control" id="npwp"></div></div>
                        <div class="col-6"><div class="form-group"><label class="form-label">Email</label><input type="text" class="form-control" id="email"></div></div>
                        <div class="col-12"><div class="form-group"><label class="form-label">Alamat</label><input type="text" class="form-control" id="alamat"></div></div>
                        <div class="col-6"><div class="form-group"><label class="form-label">No Telepon</label><input type="text" class="form-control" id="telp"></div></div>
                    </div>

                    <h4 class="mb-2 mt-2" style="border-bottom: 3px solid black; background: var(--nb-yellow);">3. Rental Unit Data</h4>
                    <div class="row p-2" style="background: #fff9db; border: 2px dashed black;">
                        <div class="col-6">
                            <div class="form-group">
                                <label class="form-label">Pilih Tipe Unit</label>
                                <select class="form-control" id="tipe_unit" onchange="updateUnitData()">
                                    <option value="">-- Pilih Unit --</option>
                                    <option value="Extra Small">Extra Small</option>
                                    <option value="Small">Small</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Regular">Regular</option>
                                    <option value="Large">Large</option>
                                    <option value="Extra Large">Extra Large</option>
                                    <option value="Jumbo">Jumbo</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6"><div class="form-group"><label class="form-label">Dimensi</label><input type="text" class="form-control auto-field" id="dimensi" readonly></div></div>
                        <div class="col-6"><div class="form-group"><label class="form-label">Harga Sewa</label><input type="text" class="form-control auto-field" id="harga_sewa" readonly></div></div>
                        <div class="col-6"><div class="form-group"><label class="form-label">Durasi (Bulan)</label><input type="number" class="form-control" id="qty_bulan" value="1" onchange="calculateTotals()"></div></div>
                    </div>

                    <h4 class="mb-2 mt-4" style="border-bottom: 3px solid black;">4. Rincian Biaya</h4>
                    <div class="table-responsive">
                        <table class="table" id="itemsTable">
                            <thead>
                                <tr>
                                    <th>Item</th><th width="10%">Qty</th><th width="15%">Unit</th><th>Harga @</th><th>Total</th>
                                    <th width="10%" style="background:#333; color:white; text-align:center;">Opsi</th> </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" class="form-control" id="row1_name" value="Sewa Gudang"></td>
                                    <td><input type="number" class="form-control" id="row1_qty" value="1" onchange="calculateTotals()"></td>
                                    <td><input type="text" class="form-control" id="row1_unit" value="Bulan"></td>
                                    <td><input type="text" class="form-control" id="row1_price" value="0" onchange="calculateTotals()"></td>
                                    <td><input type="text" class="form-control auto-field" id="row1_total" readonly></td>
                                    <td class="text-center">-</td>
                                </tr>
                                
                                <tr id="row_pickup">
                                    <td><input type="text" class="form-control" id="row2_name" value="Jasa Pickup & Helper"></td>
                                    <td><input type="number" class="form-control" id="row2_qty" value="1" onchange="calculateTotals()"></td>
                                    <td><input type="text" class="form-control" id="row2_unit" value="Trip"></td>
                                    <td><input type="text" class="form-control" id="row2_price" value="500000" onchange="calculateTotals()"></td>
                                    <td><input type="text" class="form-control auto-field" id="row2_total" readonly></td>
                                    <td class="text-center">
                                        <div class="toggle-btn">
                                            <input type="checkbox" id="chk_pickup" checked onchange="togglePickup()">
                                            <label for="chk_pickup" style="cursor:pointer; margin-bottom:0;">PAKAI</label>
                                        </div>
                                    </td>
                                </tr>
                                
                                <tr>
                                    <td><input type="text" class="form-control" id="row3_name" value="Gembok 25mm & Tag"></td>
                                    <td><input type="number" class="form-control" id="row3_qty" value="1" onchange="calculateTotals()"></td>
                                    <td><input type="text" class="form-control" id="row3_unit" value="Pcs"></td>
                                    <td><input type="text" class="form-control" id="row3_price" value="21622" onchange="calculateTotals()"></td>
                                    <td><input type="text" class="form-control auto-field" id="row3_total" readonly></td>
                                    <td class="text-center">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card bg-white p-3" style="border: 3px solid black;">
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Subtotal</label><input type="text" class="form-control mb-2 auto-field" id="subtotal" readonly>
                                <label class="form-label">PPN (11%)</label><input type="text" class="form-control auto-field" id="ppn" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Materai (Auto)</label>
                                <input type="text" class="form-control mb-2 auto-field" id="materai" readonly>
                                <label class="form-label" style="font-size: 1.2rem; color: var(--nb-blue);">GRAND TOTAL</label>
                                <input type="text" class="form-control" id="grand_total" readonly style="border: 3px solid var(--nb-blue); font-weight: 900;">
                            </div>
                        </div>
                    </div>

                </div>
                <div class="card-footer text-center">
                    <button class="btn btn-success btn-lg w-100" onclick="downloadDocx()">ðŸš€ DOWNLOAD DOCX</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PRICELIST = {
            "Extra Small": { dim: "1.5 x 1.5 x 2.5", price: 1600000 },
            "Small":       { dim: "2.2 x 1.5 x 2.5", price: 2300000 },
            "Medium":      { dim: "3.0 x 1.5 x 2.5", price: 3000000 },
            "Regular":     { dim: "3.0 x 3.0 x 2.5", price: 5900000 },
            "Large":       { dim: "3.8 x 3.0 x 2.5", price: 7300000 },
            "Extra Large": { dim: "4.5 x 3.0 x 2.5", price: 8300000 },
            "Jumbo":       { dim: "6.0 x 3.0 x 2.5", price: 10700000 }
        };

        window.onload = function() {
            setTimeout(() => {
                if (typeof PizZip !== 'undefined') {
                    document.getElementById('date').valueAsDate = new Date();
                    updateValidity(); calculateTotals();
                }
            }, 500);
        };

        function togglePickup() {
            const isChecked = document.getElementById('chk_pickup').checked;
            const row = document.getElementById('row_pickup');
            const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
            
            if (isChecked) {
                row.classList.remove('row-disabled');
                inputs.forEach(input => input.disabled = false);
            } else {
                row.classList.add('row-disabled');
                inputs.forEach(input => input.disabled = true);
            }
            calculateTotals();
        }

        function updateUnitData() {
            const tipe = document.getElementById('tipe_unit').value;
            if (PRICELIST[tipe]) {
                const data = PRICELIST[tipe];
                document.getElementById('dimensi').value = data.dim;
                document.getElementById('harga_sewa').value = formatRupiah(data.price);
                document.getElementById('row1_name').value = "Sewa Gudang " + tipe;
                document.getElementById('row1_price').value = data.price;
                calculateTotals();
            }
        }

        function updateValidity() {
            const d = new Date(document.getElementById('date').value);
            d.setMonth(d.getMonth() + 1);
            document.getElementById('validity').value = d.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function calculateTotals() {
            let subtotal = 0;

            // Row 1
            const qty1 = parseFloat(document.getElementById('row1_qty').value) || 0;
            const prc1 = parseFloat(document.getElementById('row1_price').value.toString().replace(/[^0-9]/g, '')) || 0;
            const tot1 = qty1 * prc1;
            document.getElementById('row1_total').value = formatRupiah(tot1);
            subtotal += tot1;

            // Row 2 (Pickup)
            const usePickup = document.getElementById('chk_pickup').checked;
            let tot2 = 0;
            if (usePickup) {
                const qty2 = parseFloat(document.getElementById('row2_qty').value) || 0;
                const prc2 = parseFloat(document.getElementById('row2_price').value.toString().replace(/[^0-9]/g, '')) || 0;
                tot2 = qty2 * prc2;
                document.getElementById('row2_total').value = formatRupiah(tot2);
            } else {
                document.getElementById('row2_total').value = "-";
            }
            subtotal += tot2;

            // Row 3 (Gembok)
            const qty3 = parseFloat(document.getElementById('row3_qty').value) || 0;
            const prc3 = parseFloat(document.getElementById('row3_price').value.toString().replace(/[^0-9]/g, '')) || 0;
            const tot3 = qty3 * prc3;
            document.getElementById('row3_total').value = formatRupiah(tot3);
            subtotal += tot3;

            // Calc PPN & Materai
            let ppn = Math.floor(subtotal * 0.11);
            
            let materaiVal = 0;
            if (subtotal > 5000000) {
                materaiVal = 10000;
                document.getElementById('materai').value = "Rp 10.000";
            } else {
                document.getElementById('materai').value = "-";
            }

            const grandTotal = subtotal + ppn + materaiVal;
            document.getElementById('subtotal').value = formatRupiah(subtotal);
            document.getElementById('ppn').value = formatRupiah(ppn);
            document.getElementById('grand_total').value = formatRupiah(grandTotal);
        }

        function formatRupiah(angka) {
            return "Rp " + angka.toLocaleString('id-ID');
        }

        let loadedContent = null;
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('filename-display').innerText = file.name;
            const reader = new FileReader();
            reader.onload = function(evt) {
                if (evt.target.readyState === 2) {
                    loadedContent = evt.target.result;
                    document.getElementById("app-content").style.opacity = "1";
                    document.getElementById("app-content").style.pointerEvents = "auto";
                }
            };
            reader.readAsBinaryString(file);
        }

        function downloadDocx() {
            if (!loadedContent) { alert("Upload template dulu!"); return; }

            try {
                const zip = new PizZip(loadedContent);
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true, delimiters: { start: '<<', end: '>>' } });

                const subtotalVal = parseFloat(document.getElementById("subtotal").value.replace(/[^0-9]/g, ''));
                const showMaterai = subtotalVal > 5000000;
                const usePickup = document.getElementById('chk_pickup').checked;

                const data = {
                    "No Quo": document.getElementById("no_quote").value,
                    "Date": new Date(document.getElementById('date').value).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }),
                    "Validity": document.getElementById('validity').value,
                    "Perusahaan": document.getElementById("perusahaan").value,
                    "Nama PIC": document.getElementById("pic").value,
                    "NPWP": document.getElementById("npwp").value,
                    "Email": document.getElementById("email").value,
                    "Alamat": document.getElementById("alamat").value,
                    "No Telepon": document.getElementById("telp").value,
                    
                    "Tipe Unit": document.getElementById("tipe_unit").value,
                    "Dimensi": document.getElementById("dimensi").value,
                    "Harga Sewa": document.getElementById("harga_sewa").value,
                    "Qty Bulan": document.getElementById("qty_bulan").value,
                    
                    "Item 1": document.getElementById('row1_name').value,
                    "Qty Item 1": document.getElementById('row1_qty').value,
                    "Satuan Item 1": document.getElementById('row1_unit').value,
                    "Harga Satuan Item 1": document.getElementById('row1_price').value,
                    "Harga Total Item 1": document.getElementById('row1_total').value,

                    "has_pickup": usePickup, 
                    "Item 2": document.getElementById('row2_name').value,
                    "Qty Item 2": document.getElementById('row2_qty').value,
                    "Satuan Item 2": document.getElementById('row2_unit').value,
                    "Harga Satuan Item 2": document.getElementById('row2_price').value,
                    "Harga Total Item 2": document.getElementById('row2_total').value,

                    "Item 3": document.getElementById('row3_name').value,
                    "Qty Item 3": document.getElementById('row3_qty').value,
                    "Satuan Item 3": document.getElementById('row3_unit').value,
                    "Harga Satuan Item 3": document.getElementById('row3_price').value,
                    "Harga Total Item 3": document.getElementById('row3_total').value,

                    "Total Sebelum PPN": document.getElementById("subtotal").value,
                    "PPN": document.getElementById("ppn").value,
                    "Grand Total": document.getElementById("grand_total").value,

                    "has_materai": showMaterai, 
                    "Materai": "Rp 10.000"
                };

                doc.render(data);
                const blob = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                saveAs(blob, "Quotation_" + (data["Perusahaan"] || "Draft") + ".docx");

            } catch (error) {
                console.error(error);
                alert("Gagal: " + error.message);
            }
        }
    </script>
</body>
</html>